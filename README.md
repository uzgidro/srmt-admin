# SRMT Prime

Go backend application for SRMT Prime system with dependency injection using Google Wire.

## Quick Start

### Prerequisites
- Go 1.24.4 or higher
- PostgreSQL
- MongoDB
- MinIO

### Build & Run

```bash
# Generate Wire dependency injection code
cd cmd && go run github.com/google/wire/cmd/wire && cd ..

# Build
go build -o srmt-admin.exe ./cmd

# Run
./srmt-admin.exe
```

### Configuration

**Quick Setup:**
```bash
# 1. Copy example config
cp config/local.example.yaml config/local.yaml

# 2. Edit with your settings (database credentials, API keys, etc.)
nano config/local.yaml

# 3. Set environment variable
export CONFIG_PATH=config/local.yaml
```

**Configuration files:**
- `config/*.example.yaml` - Templates (committed to git)
- `config/local.yaml` - Your local config (git-ignored, contains secrets)
- `config/dev.yaml` - Dev environment (git-ignored)
- `config/prod.yaml` - Production (git-ignored)

**ðŸ“ For detailed configuration guide, see [docs/CONFIG.md](docs/CONFIG.md)**

## Project Structure

```
.
â”œâ”€â”€ cmd/                    # Application entry point
â”‚   â”œâ”€â”€ main.go            # Main function
â”‚   â”œâ”€â”€ wire.go            # Wire injector definitions
â”‚   â””â”€â”€ wire_gen.go        # Generated by Wire (git-ignored)
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ config/            # Configuration management
â”‚   â”œâ”€â”€ http-server/       # HTTP handlers, middleware, routing
â”‚   â”œâ”€â”€ lib/               # Shared libraries and utilities
â”‚   â”œâ”€â”€ providers/         # Wire dependency providers
â”‚   â”‚   â”œâ”€â”€ config.go      # Config & logger providers
â”‚   â”‚   â”œâ”€â”€ storage.go     # Database providers
â”‚   â”‚   â”œâ”€â”€ services.go    # Service providers
â”‚   â”‚   â””â”€â”€ http.go        # HTTP layer providers
â”‚   â”œâ”€â”€ storage/           # Database drivers and repositories
â”‚   â”‚   â”œâ”€â”€ driver/        # PostgreSQL, MongoDB drivers
â”‚   â”‚   â”œâ”€â”€ repo/          # PostgreSQL repositories
â”‚   â”‚   â”œâ”€â”€ mongo/         # MongoDB repositories
â”‚   â”‚   â””â”€â”€ minio/         # MinIO client
â”‚   â””â”€â”€ token/             # JWT token service
â”œâ”€â”€ migrations/            # Database migrations
â””â”€â”€ docs/                  # Documentation
    â””â”€â”€ WIRE_FAQ.md        # Wire DI FAQ and troubleshooting
```

## Dependency Injection with Wire

This project uses [Google Wire](https://github.com/google/wire) for compile-time dependency injection.

### Why Wire?

- âœ… Zero runtime overhead (generates code at compile time)
- âœ… Compile-time safety (catches errors before runtime)
- âœ… No reflection
- âœ… Easy to debug (generated code is readable)
- âœ… Better code organization and testability

### Quick Reference

```bash
# Regenerate Wire code (required after provider changes)
cd cmd && go run github.com/google/wire/cmd/wire && cd ..

# Build application
go build -o srmt-admin.exe ./cmd

# Run application
go run ./cmd
```

### Common Tasks

#### Adding a New Dependency

1. Create a provider function in `internal/providers/`
2. Add provider to appropriate `ProviderSet`
3. Regenerate Wire: `cd cmd && go run github.com/google/wire/cmd/wire && cd ..`
4. Build and test

**ðŸ“– For detailed Wire usage, troubleshooting, and FAQ, see [docs/WIRE_FAQ.md](docs/WIRE_FAQ.md)**

## Docker

### Quick Start with Docker

```bash
# Production: Start all services (app, PostgreSQL, MongoDB, MinIO)
make docker-up

# Development: Start with live reload
make docker-dev-up

# View logs
make docker-logs
```

### How Wire Works in Docker

The Dockerfile automatically generates Wire code during the build:

```dockerfile
# Generate Wire dependency injection code
RUN cd cmd && go run github.com/google/wire/cmd/wire

# Build the entire cmd package (includes wire_gen.go)
RUN go build -o srmt-admin ./cmd
```

### Docker Commands

```bash
# Production
make docker-build      # Build image
make docker-up         # Start services
make docker-down       # Stop services
make docker-logs       # View logs

# Development
make docker-dev-up     # Start dev environment
make docker-dev-logs   # View dev logs
make docker-dev-exec   # Shell into container

# Database
make docker-db-psql    # PostgreSQL CLI
make docker-db-mongo   # MongoDB CLI
```

**ðŸ“¦ For complete Docker guide, troubleshooting, and deployment, see [docs/DOCKER.md](docs/DOCKER.md)**

### Deploying from Docker Hub

If you build and push to Docker Hub, then deploy to a server:

```bash
# On your server:
# 1. Setup (one-time)
curl -fsSL https://raw.githubusercontent.com/yourusername/srmt-prime/main/scripts/setup-server.sh | bash

# 2. Edit config with your secrets
nano /opt/srmt/config/prod.yaml

# 3. Deploy
docker pull yourusername/srmt-admin:latest
docker run -d \
  --name srmt-admin \
  -p 9010:9010 \
  -v /opt/srmt/config:/app/config:ro \
  -e CONFIG_PATH=/app/config/prod.yaml \
  yourusername/srmt-admin:latest
```

**ðŸš€ For production deployment strategies (Docker Hub, CI/CD, secrets), see [docs/PRODUCTION_DEPLOYMENT.md](docs/PRODUCTION_DEPLOYMENT.md)**

## IDE Setup (GoLand/VS Code)

### GoLand

If you get `undefined: InitializeApp` error:

1. Go to **Run** â†’ **Edit Configurations**
2. Set **Run kind** to "Package" or "Directory"
3. Set **Package path** to `srmt-admin/cmd`
4. Apply and run

### VS Code

Make sure your launch.json builds the entire package:

```json
{
    "name": "Launch Package",
    "type": "go",
    "request": "launch",
    "mode": "auto",
    "program": "${workspaceFolder}/cmd"
}
```

## Development

### Running Locally

1. Set up configuration:
```bash
export CONFIG_PATH=config/local.yaml
```

2. Ensure databases are running (PostgreSQL, MongoDB)

3. Generate Wire code:
```bash
cd cmd && go run github.com/google/wire/cmd/wire && cd ..
```

4. Run application:
```bash
go run ./cmd
```

### Building for Production

```bash
# Generate Wire code
cd cmd && go run github.com/google/wire/cmd/wire && cd ..

# Build optimized binary
go build -ldflags="-s -w" -o srmt-admin ./cmd
```

## API Endpoints

The application provides a REST API with the following main routes:

- `/auth/*` - Authentication (sign-in, refresh, me)
- `/api/v3/*` - Public API (weather, analytics, modsnow, stock)
- `/organizations/*` - Organization management
- `/users/*` - User management (admin only)
- `/events/*` - Event management
- `/discharges/*` - Discharge records
- `/files/*` - File upload/download

## Architecture

### Layers

1. **HTTP Layer** (`internal/http-server/`)
   - Handlers: Request handling and validation
   - Middleware: Auth, CORS, logging
   - Router: Route setup with dependencies

2. **Service Layer** (`internal/lib/service/`)
   - Business logic services
   - External API clients (ASCUE, Reservoir)

3. **Repository Layer** (`internal/storage/`)
   - Database operations
   - Data access abstraction

4. **Infrastructure** (`internal/storage/driver/`)
   - Database drivers
   - Storage clients (MinIO)

### Dependency Flow

```
main.go
  â””â”€> Wire InitializeApp()
       â””â”€> Providers
            â”œâ”€> Config & Logger
            â”œâ”€> Database Drivers (PostgreSQL, MongoDB)
            â”œâ”€> Repositories
            â”œâ”€> Services (Token, ASCUE, Reservoir)
            â””â”€> HTTP Server (Router, Handlers)
```

## Database Migrations

Migrations are automatically run on application startup using [golang-migrate](https://github.com/golang-migrate/migrate).

Migration files location: `migrations/`

## Troubleshooting

### Build Error: "undefined: InitializeApp"

Wire code needs to be generated. Run:
```bash
cd cmd && go run github.com/google/wire/cmd/wire && cd ..
```

### IDE Building Only main.go

Update IDE configuration to build the entire `cmd` package, not just `main.go`.

See [docs/WIRE_FAQ.md](docs/WIRE_FAQ.md) for detailed troubleshooting.
