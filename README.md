# SRMT Prime

Go backend application for SRMT Prime system with dependency injection using Google Wire.

## Quick Start

### Prerequisites
- Go 1.24.4 or higher
- PostgreSQL
- MongoDB
- MinIO

### Build & Run

```bash
# Generate Wire dependency injection code
cd cmd && go run github.com/google/wire/cmd/wire && cd ..

# Build
go build -o srmt-admin.exe ./cmd

# Run
./srmt-admin.exe
```

### Configuration

Set the `CONFIG_PATH` environment variable to point to your config file:

```bash
export CONFIG_PATH=config/local.yaml
```

Available config files:
- `config/local.yaml` - Local development
- `config/dev.yaml` - Development environment
- `config/prod.yaml` - Production environment

## Project Structure

```
.
â”œâ”€â”€ cmd/                    # Application entry point
â”‚   â”œâ”€â”€ main.go            # Main function
â”‚   â”œâ”€â”€ wire.go            # Wire injector definitions
â”‚   â””â”€â”€ wire_gen.go        # Generated by Wire (git-ignored)
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ config/            # Configuration management
â”‚   â”œâ”€â”€ http-server/       # HTTP handlers, middleware, routing
â”‚   â”œâ”€â”€ lib/               # Shared libraries and utilities
â”‚   â”œâ”€â”€ providers/         # Wire dependency providers
â”‚   â”‚   â”œâ”€â”€ config.go      # Config & logger providers
â”‚   â”‚   â”œâ”€â”€ storage.go     # Database providers
â”‚   â”‚   â”œâ”€â”€ services.go    # Service providers
â”‚   â”‚   â””â”€â”€ http.go        # HTTP layer providers
â”‚   â”œâ”€â”€ storage/           # Database drivers and repositories
â”‚   â”‚   â”œâ”€â”€ driver/        # PostgreSQL, MongoDB drivers
â”‚   â”‚   â”œâ”€â”€ repo/          # PostgreSQL repositories
â”‚   â”‚   â”œâ”€â”€ mongo/         # MongoDB repositories
â”‚   â”‚   â””â”€â”€ minio/         # MinIO client
â”‚   â””â”€â”€ token/             # JWT token service
â”œâ”€â”€ migrations/            # Database migrations
â””â”€â”€ docs/                  # Documentation
    â””â”€â”€ WIRE_FAQ.md        # Wire DI FAQ and troubleshooting
```

## Dependency Injection with Wire

This project uses [Google Wire](https://github.com/google/wire) for compile-time dependency injection.

### Why Wire?

- âœ… Zero runtime overhead (generates code at compile time)
- âœ… Compile-time safety (catches errors before runtime)
- âœ… No reflection
- âœ… Easy to debug (generated code is readable)
- âœ… Better code organization and testability

### Quick Reference

```bash
# Regenerate Wire code (required after provider changes)
cd cmd && go run github.com/google/wire/cmd/wire && cd ..

# Build application
go build -o srmt-admin.exe ./cmd

# Run application
go run ./cmd
```

### Common Tasks

#### Adding a New Dependency

1. Create a provider function in `internal/providers/`
2. Add provider to appropriate `ProviderSet`
3. Regenerate Wire: `cd cmd && go run github.com/google/wire/cmd/wire && cd ..`
4. Build and test

**ðŸ“– For detailed Wire usage, troubleshooting, and FAQ, see [docs/WIRE_FAQ.md](docs/WIRE_FAQ.md)**

## IDE Setup (GoLand/VS Code)

### GoLand

If you get `undefined: InitializeApp` error:

1. Go to **Run** â†’ **Edit Configurations**
2. Set **Run kind** to "Package" or "Directory"
3. Set **Package path** to `srmt-admin/cmd`
4. Apply and run

### VS Code

Make sure your launch.json builds the entire package:

```json
{
    "name": "Launch Package",
    "type": "go",
    "request": "launch",
    "mode": "auto",
    "program": "${workspaceFolder}/cmd"
}
```

## Development

### Running Locally

1. Set up configuration:
```bash
export CONFIG_PATH=config/local.yaml
```

2. Ensure databases are running (PostgreSQL, MongoDB)

3. Generate Wire code:
```bash
cd cmd && go run github.com/google/wire/cmd/wire && cd ..
```

4. Run application:
```bash
go run ./cmd
```

### Building for Production

```bash
# Generate Wire code
cd cmd && go run github.com/google/wire/cmd/wire && cd ..

# Build optimized binary
go build -ldflags="-s -w" -o srmt-admin ./cmd
```

## API Endpoints

The application provides a REST API with the following main routes:

- `/auth/*` - Authentication (sign-in, refresh, me)
- `/api/v3/*` - Public API (weather, analytics, modsnow, stock)
- `/organizations/*` - Organization management
- `/users/*` - User management (admin only)
- `/events/*` - Event management
- `/discharges/*` - Discharge records
- `/files/*` - File upload/download

## Architecture

### Layers

1. **HTTP Layer** (`internal/http-server/`)
   - Handlers: Request handling and validation
   - Middleware: Auth, CORS, logging
   - Router: Route setup with dependencies

2. **Service Layer** (`internal/lib/service/`)
   - Business logic services
   - External API clients (ASCUE, Reservoir)

3. **Repository Layer** (`internal/storage/`)
   - Database operations
   - Data access abstraction

4. **Infrastructure** (`internal/storage/driver/`)
   - Database drivers
   - Storage clients (MinIO)

### Dependency Flow

```
main.go
  â””â”€> Wire InitializeApp()
       â””â”€> Providers
            â”œâ”€> Config & Logger
            â”œâ”€> Database Drivers (PostgreSQL, MongoDB)
            â”œâ”€> Repositories
            â”œâ”€> Services (Token, ASCUE, Reservoir)
            â””â”€> HTTP Server (Router, Handlers)
```

## Database Migrations

Migrations are automatically run on application startup using [golang-migrate](https://github.com/golang-migrate/migrate).

Migration files location: `migrations/`

## Troubleshooting

### Build Error: "undefined: InitializeApp"

Wire code needs to be generated. Run:
```bash
cd cmd && go run github.com/google/wire/cmd/wire && cd ..
```

### IDE Building Only main.go

Update IDE configuration to build the entire `cmd` package, not just `main.go`.

See [docs/WIRE_FAQ.md](docs/WIRE_FAQ.md) for detailed troubleshooting.
